<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§å†°ç®±å€‰å„²ç³»çµ± - è¡Œå‹•å„ªåŒ–ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f8fafc; 
            -webkit-tap-highlight-color: transparent;
        }
        .expired { background-color: #fff1f2 !important; border-left: 5px solid #ef4444; }
        .warning { background-color: #fff7ed !important; border-left: 5px solid #f97316; }
        .hidden { display: none; }
        .tab-active { background-color: #2563eb !important; color: white !important; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.4); }

        /* æ‰‹æ©Ÿç‰ˆ RWD å¡ç‰‡åŒ–è¨­è¨ˆ */
        @media (max-width: 768px) {
            thead { display: none; } /* éš±è—è¡¨é ­ */
            
            #inventoryList tr {
                display: block;
                margin-bottom: 1.25rem;
                background: white;
                border-radius: 16px;
                padding: 12px;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                border: 1px solid #e2e8f0;
            }

            #inventoryList td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 8px;
                border: none;
                text-align: right;
            }

            /* æ‰‹æ©Ÿç‰ˆæ¬„ä½æ¨™ç±¤ */
            #inventoryList td::before {
                content: attr(data-label);
                font-weight: 700;
                color: #94a3b8;
                font-size: 0.8rem;
                flex-shrink: 0;
            }

            #inventoryList td:last-child {
                border-top: 1px dashed #e2e8f0;
                margin-top: 8px;
                padding-top: 15px;
                justify-content: center;
            }
            
            /* è®“æŒ‰éˆ•åœ¨æ‰‹æ©Ÿä¸Šæ›´å¤§æ›´å¥½æŒ‰ */
            .btn-action {
                width: 100%;
                padding: 12px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        <div id="loginSection" class="text-center py-20 bg-white rounded-3xl shadow-xl border border-slate-100">
            <div class="text-6xl mb-6">â„ï¸</div>
            <h1 class="text-3xl font-bold text-slate-800 mb-2">æ™ºæ…§å†°ç®±å€‰å„²</h1>
            <p class="text-slate-500 mb-10">é›²ç«¯åŒæ­¥ Â· é£Ÿæç®¡ç† Â· éæœŸæé†’</p>
            <button id="btnLogin" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-10 rounded-2xl transition-all active:scale-95 shadow-lg shadow-blue-200">
                ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
            </button>
        </div>

        <div id="mainApp" class="hidden">
            <header class="mb-8 flex justify-between items-end">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800">æˆ‘çš„æ™ºæ…§å†°ç®± ğŸ§Š</h1>
                    <p class="text-slate-500 text-sm">Hi, <span id="userNameDisplay" class="font-bold text-blue-600"></span></p>
                </div>
                <button id="btnLogout" class="text-xs text-slate-400 bg-slate-100 px-3 py-1 rounded-full hover:bg-red-50 hover:text-red-500 transition">ç™»å‡º</button>
            </header>

            <div class="bg-white rounded-2xl shadow-sm p-5 mb-6 border border-slate-100">
                <h2 class="text-lg font-bold mb-4 text-slate-700 flex items-center gap-2">
                    <span class="bg-blue-100 p-1 rounded-md text-sm">â•</span> å¿«é€Ÿæ–°å¢é£Ÿæ
                </h2>
                <form id="foodForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                    <div class="flex flex-col lg:col-span-2">
                        <label class="text-xs font-bold text-slate-400 mb-1 ml-1">é£Ÿæåç¨± / æ•¸é‡</label>
                        <div class="flex gap-2">
                            <input type="text" id="foodName" placeholder="ä¾‹å¦‚ï¼šé®®ä¹³" required class="flex-1 border border-slate-200 bg-slate-50 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition">
                            <input type="text" id="foodQty" placeholder="1 ç“¶" required class="w-24 border border-slate-200 bg-slate-50 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition">
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <label class="text-xs font-bold text-slate-400 mb-1 ml-1">å„²å­˜ä½ç½®</label>
                        <select id="foodLocation" class="border border-slate-200 bg-slate-50 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition">
                            <option value="fridge">å†·è—åº« (Chilled)</option>
                            <option value="freezer">å†·å‡åº« (Frozen)</option>
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label class="text-xs font-bold text-slate-400 mb-1 ml-1">æ”¾å…¥æ—¥æœŸ</label>
                        <input type="date" id="addedDate" required class="border border-slate-200 bg-slate-50 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-xs font-bold text-slate-400 mb-1 ml-1">ä¿å­˜æœŸé™</label>
                        <input type="date" id="expiryDate" required class="border border-slate-200 bg-slate-50 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition">
                    </div>
                    <div class="flex items-end">
                        <button type="submit" class="w-full bg-slate-800 hover:bg-black text-white font-bold py-3.5 rounded-xl transition active:scale-95 shadow-md">åŠ å…¥æ¸…å–®</button>
                    </div>
                </form>
            </div>

            <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-4">
                <div class="flex bg-white rounded-xl p-1 shadow-sm border border-slate-100 w-full md:w-auto" id="filterTabs">
                    <button onclick="window.filterBy('all')" id="btn-all" class="flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold tab-active transition">å…¨éƒ¨</button>
                    <button onclick="window.filterBy('fridge')" id="btn-fridge" class="flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition">å†·è—</button>
                    <button onclick="window.filterBy('freezer')" id="btn-freezer" class="flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition">å†·å‡</button>
                </div>
                <div class="flex items-center gap-2 w-full md:w-auto">
                    <select id="sortSelect" onchange="window.sortBy(this.value)" class="w-full border border-slate-200 bg-white rounded-xl p-2.5 text-sm font-medium outline-none shadow-sm">
                        <option value="expiryDate">â³ æŒ‰åˆ°æœŸæ—¥ (æœ€è¿‘å„ªå…ˆ)</option>
                        <option value="addedDate">ğŸ“… æŒ‰æ”¾å…¥æ—¥ (æœ€æ–°å„ªå…ˆ)</option>
                        <option value="name">ğŸ”¤ æŒ‰åç¨± (A-Z)</option>
                    </select>
                </div>
            </div>

            <div class="overflow-hidden">
                <table class="w-full text-left border-separate border-spacing-y-0">
                    <thead>
                        <tr class="text-slate-400 uppercase text-xs font-bold tracking-wider">
                            <th class="py-4 px-6">å…§å®¹</th>
                            <th class="py-4 px-6">æ•¸é‡</th>
                            <th class="py-4 px-6 text-center">ç‹€æ…‹</th>
                            <th class="py-4 px-6">æ—¥æœŸ</th>
                            <th class="py-4 px-6 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryList" class="text-slate-600"></tbody>
                </table>
                <div id="emptyState" class="py-20 text-center bg-white rounded-3xl border border-dashed border-slate-300 text-slate-400 hidden">
                    <div class="text-4xl mb-2">ğŸƒ</div>
                    é€™è£¡ç©ºç©ºå¦‚ä¹Ÿ...
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // é€™è£¡è²¼ä¸Šä½ çš„ Firebase Config (å·²å¸¶å…¥ä½ ä¹‹å‰çš„è¨­å®š)
        const firebaseConfig = {
            apiKey: "AIzaSyCbYzfYlzmDZ9ETC16a5VGhpNd_BqXRsiE",
            authDomain: "refrigerator-80650.firebaseapp.com",
            projectId: "refrigerator-80650",
            storageBucket: "refrigerator-80650.firebasestorage.app",
            messagingSenderId: "884391692114",
            appId: "1:884391692114:web:0614bba6a928efcd275c8b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentFilter = 'all';
        let currentSort = 'expiryDate';
        let unsubscribe = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userNameDisplay').innerText = user.displayName;
                refreshData();
            } else {
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
                if (unsubscribe) unsubscribe();
            }
        });

        function refreshData() {
            if (unsubscribe) unsubscribe();
            let q;
            const colRef = collection(db, "fridgeInventory");
            if (currentFilter === 'all') {
                q = query(colRef, orderBy(currentSort, "asc"));
            } else {
                q = query(colRef, where("location", "==", currentFilter), orderBy(currentSort, "asc"));
            }

            unsubscribe = onSnapshot(q, (snapshot) => {
                const list = document.getElementById('inventoryList');
                list.innerHTML = '';
                document.getElementById('emptyState').classList.toggle('hidden', !snapshot.empty);

                snapshot.forEach((docSnap) => {
                    const item = docSnap.data();
                    const status = calculateStatus(item.expiryDate);
                    const locTag = item.location === 'freezer' ? 
                        '<span class="bg-indigo-100 text-indigo-600 text-[10px] font-bold px-2 py-0.5 rounded-lg mr-2">å†·å‡</span>' : 
                        '<span class="bg-cyan-100 text-cyan-600 text-[10px] font-bold px-2 py-0.5 rounded-lg mr-2">å†·è—</span>';

                    const row = document.createElement('tr');
                    row.className = `md:border-b border-slate-100 transition-all ${status.class}`;
                    row.innerHTML = `
                        <td class="py-4 px-6 font-bold text-slate-800" data-label="é£Ÿæä½ç½®">${locTag}${item.name}</td>
                        <td class="py-4 px-6" data-label="å‰©é¤˜æ•¸é‡">${item.qty}</td>
                        <td class="py-4 px-6 text-center" data-label="æ–°é®®ç‹€æ…‹">
                            <span class="px-3 py-1 rounded-full text-[11px] font-black tracking-tighter ${status.urgent ? 'bg-red-500 text-white animate-pulse' : 'bg-slate-100 text-slate-500'}">
                                ${status.label}
                            </span>
                        </td>
                        <td class="py-4 px-6" data-label="æ—¥æœŸè³‡è¨Š">
                            <div class="text-[10px] text-slate-400">æ”¾å…¥: ${item.addedDate}</div>
                            <div class="font-bold text-xs">æœŸé™: ${item.expiryDate}</div>
                        </td>
                        <td class="py-4 px-6 text-center">
                            <button class="btn-action bg-red-50 text-red-500 px-4 py-2 rounded-xl text-xs font-bold hover:bg-red-500 hover:text-white transition-all" onclick="window.removeItem('${docSnap.id}')">
                                ğŸ—‘ï¸ ç§»é™¤é£Ÿæ
                            </button>
                        </td>
                    `;
                    list.appendChild(row);
                });
            });
        }

        function calculateStatus(expiryDateStr) {
            const today = new Date(); today.setHours(0,0,0,0);
            const expiry = new Date(expiryDateStr);
            const diffDays = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
            if (diffDays < 0) return { label: 'å·²éæœŸ', class: 'expired', urgent: true };
            if (diffDays <= 3) return { label: `å‰© ${diffDays} å¤©`, class: 'warning', urgent: true };
            return { label: `å‰©é¤˜ ${diffDays} å¤©`, class: '', urgent: false };
        }

        document.getElementById('foodForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerText = "å„²å­˜ä¸­...";
            try {
                await addDoc(collection(db, "fridgeInventory"), {
                    name: document.getElementById('foodName').value,
                    qty: document.getElementById('foodQty').value,
                    location: document.getElementById('foodLocation').value,
                    addedDate: document.getElementById('addedDate').value,
                    expiryDate: document.getElementById('expiryDate').value,
                    userId: auth.currentUser.uid,
                    createdAt: serverTimestamp()
                });
                e.target.reset();
                document.getElementById('addedDate').valueAsDate = new Date();
            } finally {
                btn.disabled = false;
                btn.innerText = "åŠ å…¥æ¸…å–®";
            }
        };

        window.filterBy = (loc) => {
            currentFilter = loc;
            document.querySelectorAll('#filterTabs button').forEach(b => b.classList.remove('tab-active'));
            document.getElementById(`btn-${loc}`).classList.add('tab-active');
            refreshData();
        };

        window.sortBy = (val) => { currentSort = val; refreshData(); };
        window.removeItem = async (id) => { if (confirm('è¦ç§»é™¤é€™é …é£Ÿæå—ï¼Ÿ')) await deleteDoc(doc(db, "fridgeInventory", id)); };
        document.getElementById('btnLogin').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('btnLogout').onclick = () => signOut(auth);
        document.getElementById('addedDate').valueAsDate = new Date();
    </script>
</body>
</html>
