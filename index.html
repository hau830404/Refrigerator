<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§å†°ç®± - è¡Œå‹•å„ªåŒ–çµ‚æ¥µç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f8fafc; 
            -webkit-tap-highlight-color: transparent;
        }
        .expired { background-color: #fff1f2 !important; border-left: 5px solid #ef4444; }
        .warning { background-color: #fff7ed !important; border-left: 5px solid #f97316; }
        .hidden { display: none; }
        .tab-active { background-color: #2563eb !important; color: white !important; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.4); }

        /* æ‰‹æ©Ÿ RWD æ’ç‰ˆæ ¸å¿ƒ */
        @media (max-width: 768px) {
            thead { display: none; }
            #inventoryList tr {
                display: block;
                margin-bottom: 1rem;
                background: white;
                border-radius: 16px;
                padding: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                border: 1px solid #e2e8f0;
            }
            #inventoryList td {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                padding: 8px;
                border: none;
            }
            #inventoryList td::before {
                content: attr(data-label);
                font-weight: 700;
                color: #94a3b8;
                font-size: 0.75rem;
                margin-top: 4px;
                flex-shrink: 0;
                width: 70px; /* å›ºå®šå¯¬åº¦è®“æ¨™ç±¤å°é½Š */
                text-align: left;
            }
            /* é£Ÿæåç¨±å°ˆå±¬ï¼šè‡ªå‹•æ–·è¡Œ */
            #inventoryList td[data-label="å…§å®¹"] {
                flex-direction: row;
                text-align: right;
                word-break: break-all;
            }
            #inventoryList td[data-label="å…§å®¹"] > div {
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                width: 100%;
            }
            #inventoryList td:last-child {
                border-top: 1px dashed #f1f5f9;
                margin-top: 4px;
                padding-top: 12px;
                justify-content: center;
            }
            .btn-action { width: 100%; padding: 10px; }
        }
    </style>
</head>
<body class="p-3 md:p-8">
    <div class="max-w-5xl mx-auto">
        <header id="mainHeader" class="hidden mb-6 flex justify-between items-end">
            <div>
                <h1 class="text-xl font-bold text-slate-800">æˆ‘çš„æ™ºæ…§å†°ç®± ğŸ§Š</h1>
                <p class="text-slate-500 text-xs">User: <span id="userNameDisplay" class="text-blue-600"></span></p>
            </div>
            <button id="btnLogout" class="text-xs text-slate-400 bg-white px-3 py-1 rounded-full border shadow-sm">ç™»å‡º</button>
        </header>

        <div id="loginSection" class="text-center py-20 bg-white rounded-3xl shadow-xl border border-slate-100">
            <div class="text-5xl mb-4">â„ï¸</div>
            <h1 class="text-2xl font-bold text-slate-800 mb-6">æ™ºæ…§å†°ç®±ç®¡ç†</h1>
            <button id="btnLogin" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-2xl shadow-lg">ä½¿ç”¨ Google ç™»å…¥</button>
        </div>

        <div id="mainApp" class="hidden">
            <div class="bg-white rounded-2xl shadow-sm p-4 mb-6 border border-slate-100">
                <form id="foodForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-3">
                    <div class="flex flex-col lg:col-span-2">
                        <label class="text-xs font-bold text-slate-400 mb-1 ml-1">é£Ÿæåç¨±èˆ‡æ•¸é‡</label>
                        <div class="flex flex-col md:flex-row gap-2">
                            <input type="text" id="foodName" placeholder="åç¨± (ä¾‹å¦‚: é«˜é®®ä¹³)" required class="flex-1 border border-slate-200 bg-slate-50 rounded-xl p-3 outline-none focus:bg-white transition">
                            <input type="text" id="foodQty" placeholder="æ•¸é‡" required class="w-full md:w-24 border border-slate-200 bg-slate-50 rounded-xl p-3 outline-none focus:bg-white transition">
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <label class="text-xs font-bold text-slate-400 mb-1 ml-1">å„²å­˜ä½ç½®</label>
                        <select id="foodLocation" class="border border-slate-200 bg-slate-50 rounded-xl p-3 outline-none focus:bg-white">
                            <option value="fridge">å†·è—åº«</option>
                            <option value="freezer">å†·å‡åº«</option>
                        </select>
                    </div>
                    <div class="flex flex-col text-xs">
                        <label class="font-bold text-slate-400 mb-1 ml-1">æ”¾å…¥æ—¥æœŸ</label>
                        <input type="date" id="addedDate" required class="border border-slate-200 bg-slate-50 rounded-xl p-2 outline-none">
                    </div>
                    <div class="flex flex-col text-xs">
                        <label class="font-bold text-slate-400 mb-1 ml-1">ä¿å­˜æœŸé™</label>
                        <input type="date" id="expiryDate" required class="border border-slate-200 bg-slate-50 rounded-xl p-2 outline-none">
                    </div>
                    <div class="flex items-end">
                        <button type="submit" class="w-full bg-slate-800 text-white font-bold py-3 rounded-xl active:scale-95 transition">åŠ å…¥</button>
                    </div>
                </form>
            </div>

            <div class="flex flex-col md:flex-row gap-3 mb-4">
                <div class="flex bg-white rounded-xl p-1 shadow-sm border border-slate-100 w-full md:w-auto" id="filterTabs">
                    <button onclick="window.filterBy('all')" id="btn-all" class="flex-1 px-4 py-2 rounded-lg text-sm font-bold tab-active">å…¨éƒ¨</button>
                    <button onclick="window.filterBy('fridge')" id="btn-fridge" class="flex-1 px-4 py-2 rounded-lg text-sm font-bold">å†·è—</button>
                    <button onclick="window.filterBy('freezer')" id="btn-freezer" class="flex-1 px-4 py-2 rounded-lg text-sm font-bold">å†·å‡</button>
                </div>
                <select id="sortSelect" onchange="window.sortBy(this.value)" class="flex-1 md:flex-none border border-slate-200 bg-white rounded-xl p-2 text-sm outline-none">
                    <option value="expiryDate">â³ ä¾åˆ°æœŸæ—¥</option>
                    <option value="addedDate">ğŸ“… ä¾æ”¾å…¥æ—¥</option>
                    <option value="name">ğŸ”¤ ä¾åç¨±</option>
                </select>
            </div>

            <div class="overflow-hidden">
                <table class="w-full text-left">
                    <thead class="text-slate-400 text-xs font-bold uppercase">
                        <tr>
                            <th class="py-3 px-4">å…§å®¹</th>
                            <th class="py-3 px-4">æ•¸é‡</th>
                            <th class="py-3 px-4 text-center">ç‹€æ…‹</th>
                            <th class="py-3 px-4">æ—¥æœŸ</th>
                            <th class="py-3 px-4 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryList" class="text-slate-600 text-sm"></tbody>
                </table>
                <div id="emptyState" class="py-10 text-center text-slate-400 hidden">ç›®å‰æ²’æœ‰é£Ÿæ</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCbYzfYlzmDZ9ETC16a5VGhpNd_BqXRsiE",
            authDomain: "refrigerator-80650.firebaseapp.com",
            projectId: "refrigerator-80650",
            storageBucket: "refrigerator-80650.firebasestorage.app",
            messagingSenderId: "884391692114",
            appId: "1:884391692114:web:0614bba6a928efcd275c8b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentFilter = 'all';
        let currentSort = 'expiryDate';
        let unsubscribe = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('mainHeader').classList.remove('hidden');
                document.getElementById('userNameDisplay').innerText = user.displayName;
                refreshData();
            } else {
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('mainHeader').classList.add('hidden');
                if (unsubscribe) unsubscribe();
            }
        });

        function refreshData() {
            if (unsubscribe) unsubscribe();
            let q;
            const colRef = collection(db, "fridgeInventory");
            q = (currentFilter === 'all') ? query(colRef, orderBy(currentSort, "asc")) : query(colRef, where("location", "==", currentFilter), orderBy(currentSort, "asc"));

            unsubscribe = onSnapshot(q, (snapshot) => {
                const list = document.getElementById('inventoryList');
                list.innerHTML = '';
                document.getElementById('emptyState').classList.toggle('hidden', !snapshot.empty);

                snapshot.forEach((docSnap) => {
                    const item = docSnap.data();
                    const status = calculateStatus(item.expiryDate);
                    const locTag = item.location === 'freezer' ? '<span class="bg-indigo-100 text-indigo-600 text-[10px] px-2 py-0.5 rounded-md mb-1 inline-block">å†·å‡</span>' : '<span class="bg-cyan-100 text-cyan-600 text-[10px] px-2 py-0.5 rounded-md mb-1 inline-block">å†·è—</span>';

                    const row = document.createElement('tr');
                    row.className = `md:border-b border-slate-100 transition-all ${status.class}`;
                    row.innerHTML = `
                        <td class="py-4 px-6 font-bold" data-label="å…§å®¹">
                            <div>${locTag}<span>${item.name}</span></div>
                        </td>
                        <td class="py-4 px-6" data-label="æ•¸é‡">
                            <span class="bg-slate-50 md:bg-transparent px-2 py-1 rounded-md text-slate-500">${item.qty}</span>
                        </td>
                        <td class="py-4 px-6 text-center" data-label="ç‹€æ…‹">
                            <span class="px-3 py-1 rounded-full text-[10px] font-black ${status.urgent ? 'bg-red-500 text-white animate-pulse' : 'bg-slate-100 text-slate-400'}">
                                ${status.label}
                            </span>
                        </td>
                        <td class="py-4 px-6" data-label="æ—¥æœŸ">
                            <div class="text-[10px] text-slate-400">${item.addedDate} å…¥</div>
                            <div class="font-bold text-xs">${item.expiryDate} æ­¢</div>
                        </td>
                        <td class="py-4 px-6 text-center">
                            <button class="btn-action bg-red-50 text-red-500 px-3 py-2 rounded-xl text-xs font-bold active:bg-red-500 active:text-white" onclick="window.removeItem('${docSnap.id}')">
                                ç§»é™¤
                            </button>
                        </td>
                    `;
                    list.appendChild(row);
                });
            });
        }

        function calculateStatus(date) {
            const today = new Date(); today.setHours(0,0,0,0);
            const exp = new Date(date);
            const diff = Math.ceil((exp - today) / 86400000);
            if (diff < 0) return { label: 'å·²éæœŸ', class: 'expired', urgent: true };
            if (diff <= 3) return { label: `å‰© ${diff} å¤©`, class: 'warning', urgent: true };
            return { label: `å‰© ${diff} å¤©`, class: '', urgent: false };
        }

        document.getElementById('foodForm').onsubmit = async (e) => {
            e.preventDefault();
            await addDoc(collection(db, "fridgeInventory"), {
                name: document.getElementById('foodName').value,
                qty: document.getElementById('foodQty').value,
                location: document.getElementById('foodLocation').value,
                addedDate: document.getElementById('addedDate').value,
                expiryDate: document.getElementById('expiryDate').value,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });
            e.target.reset();
            document.getElementById('addedDate').valueAsDate = new Date();
        };

        window.filterBy = (loc) => {
            currentFilter = loc;
            document.querySelectorAll('#filterTabs button').forEach(b => b.classList.remove('tab-active'));
            document.getElementById(`btn-${loc}`).classList.add('tab-active');
            refreshData();
        };

        window.sortBy = (val) => { currentSort = val; refreshData(); };
        window.removeItem = async (id) => { if (confirm('ç§»é™¤ï¼Ÿ')) await deleteDoc(doc(db, "fridgeInventory", id)); };
        document.getElementById('btnLogin').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('btnLogout').onclick = () => signOut(auth);
        document.getElementById('addedDate').valueAsDate = new Date();
    </script>
</body>
</html>
